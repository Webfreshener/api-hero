<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/utils.js | api-hero</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Reactive OpenApi Client"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="api-hero"><meta property="twitter:description" content="Reactive OpenApi Client"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Webfreshener/api-hero"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/collection-proxy.js~CollectionProxy.html">CollectionProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/metadata.js~metadata.html">metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ns-options.js~NSOptions.html">NSOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/query.js~query.html">query</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/rest-request.js~RestRequest.html">RestRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/rest-response.js~RestResponse.html">RestResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/schema-builder.js~SchemaBuilder.html">SchemaBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils.js~Utils.html">Utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-namespace">namespace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createElementClass">createElementClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_cids">_cids</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_modelRefs">_modelRefs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_modelStats">_modelStats</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_models">_models</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_namespaces">_namespaces</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_nsElements">_nsElements</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_requests">_requests</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_subjects">_subjects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_traits">_traits</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#params">params</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/params/params-item.js~ParamsItem.html">ParamsItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/params/request-params.js~RequestParams.html">RequestParams</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import pairs from &quot;lodash.pairs&quot;;
import map from &quot;lodash.map&quot;;
import deepEqual from &quot;deep-equal&quot;;
import uniqWith from &quot;lodash.uniqwith&quot;;
import uniqueid from &quot;lodash.uniqueid&quot;;

/**
 * Utility Methods
 */
export class Utils {
    /**
     *
     * @param $scope
     */
    constructor($scope) {
        Object.defineProperty(this, &quot;$scope&quot;, {
            get: () =&gt; $scope,
            enumerable: false,
            configurable: false,
        });
    }

    /**
     * Helper Method returns REST Request Headers from Config
     * @returns {*}
     */
    get apiOptions() {
        let o;
        // TODO: Clean this up
        o = {
            contentType: &quot;application/json&quot;,
            // processData: false,
            dataType: &quot;json&quot;,
            // data: null,
            headers: {
                &quot;Content-Type&quot;: &quot;application/json&quot;,
                // &quot;X-Application-Id&quot;: this.$scope.options.APP_ID || null,
                // &quot;X-REST-API-Key&quot;: this.$scope.options.REST_KEY || null,
                // &quot;X-CSRF-Token&quot;: this.$scope.options.CSRF_TOKEN || null,
                // &quot;X-User-Email&quot;: this.$scope.options.USER_EMAIL || null,
            },
            mode: &quot;cors&quot;, // no-cors, cors, *same-origin
            cache: &quot;no-cache&quot;, // *default, no-cache, reload, force-cache, only-if-cached
            credentials: &quot;same-origin&quot;, // include, *same-origin, omit
            redirect: &quot;follow&quot;, // manual, *follow, error
            referrer: &quot;no-referrer&quot;, // no-referrer, *client
        };

        return o;
    }

    /**
     * Returns true if polyfill is set on `fetch` function
     * @returns {boolean}
     */
    get isFetchPolyfill() {
        const _env = (global || window);
        return _env.fetch.hasOwnProperty(&quot;polyfill&quot;);
    }

    /**
     *
     * @param route
     * @returns {boolean}
     */
    validateRoute(route) {
        const Rx = `^(${this.$scope.regEscape(this.getAPIUrl())}\/)+`;
        // throws error if route does not pass validation
        if (!route.match(new RegExp(Rx))) {
            throw `Bad route: ${route}`;
        }
        // returns true if no error thrown
        return true;
    }

    /**
     * Implementation of Parse._parseDate used to parse iso8601 UTC formatted `datetime`
     * @param iso8601
     * @returns {*}
     */
    parseDate(iso8601) {
        // returns null if `iso8601` argument fails `RegExp`
        let t;
        let Rx = /^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;
        if ((t = `${iso8601}`.match(Rx)) === null) {
            return null;
        }
        t = t.map((i) =&gt; i &amp;&amp; i.match(/^[\d]+$/) !== null ? parseInt(i, 10) : null)
            .filter((i) =&gt; i !== null);
        t[1] = t[1] - 1;
        return new Date(Date.UTC.apply(this, t));
    }

    /**
     * Returns passes object as Key/Value paired string
     * @param obj
     * @returns {string}
     */
    querify(obj) {
        return (map(pairs(obj || {}), (v, k) =&gt; v.join(&quot;=&quot;))).join(&quot;&amp;&quot;);
    }

    /**
     * generates unique Request ID
     * @param target
     * @param type
     * @returns {string}
     */
    createRequestId(target, type) {
        return uniqueid(`${target.$className}-${type}-`);
    }

    // STATIC METHODS

    /**
     *
     * @param $ref
     * @param schema
     * @returns Object | null
     */
    static getComponent($ref, schema) {
        if (!schema.hasOwnProperty(&quot;components&quot;)) {
            return null;
        }

        $ref = $ref.replace(/#\/?components\/schemas\//, &quot;&quot;);
        return schema.components.schemas.hasOwnProperty($ref) ? schema.components.schemas[$ref] : null;

    };

    static getLookupQuery(model) {

    }

    /**
     * TODO: remove if defunct/unused
     * @param model
     * @param collection
     * @private
     */
    static createReference(model, collection) {
        const _ref = collection.createModelRef();
        return new _ref(model);
    };

    /**
     *
     * @param content
     * @returns {boolean|string|object}
     */
    static getSchemaRef(content) {
        let $ref = false;
        if (content.hasOwnProperty(&quot;application/json&quot;)) {
            let _sPath = content[&quot;application/json&quot;].schema;

            if (_sPath.hasOwnProperty(&quot;$ref&quot;)) {
                $ref = _sPath.$ref;
            } else if (_sPath.hasOwnProperty(&quot;items&quot;)) {
                $ref = _sPath.items.$ref;
            } else if (_sPath.hasOwnProperty(&quot;properties&quot;)) {
                $ref = _sPath;
            }
        }
        return $ref;
    }

    static getRequestParamsSchema(operation) {

    }

    /**
     *
     * @param operation
     * @returns {*}
     */
    static getResponseSchema(operation) {
        const _codes = Object.keys(operation.responses);
        const successRx = new RegExp(&quot;^2+[0-9]{2}$&quot;);
        const _successCode = _codes.find((code) =&gt; successRx.exec(code) !== null);
        if (_successCode) {
             let _res = Utils.getSchemaRef(operation.responses[_successCode].content);
             if (typeof _res === &quot;string&quot;) {
                 _res = {$ref: _res};
             }

             return _res;
        }

        return false;
    }

    /**
     * Retrieves schema or schema ref for operation request
     *
     * @param operation
     * @returns {*}
     */
    static getRequestSchema(operation) {
        const _pVals = [&quot;requestBody&quot;, &quot;content&quot;, &quot;application/json&quot;, &quot;schema&quot;];
        let _schema = operation;
        _pVals.forEach((val) =&gt; {
            try {
                _schema = _schema[val];
            } catch (e) {
                _schema = null;
                throw new Error(e);
            }
        });

        return _schema;
    }

    /**
     * Attempts to derive model schema from element
     *
     * @param elPath
     * @returns {*}
     * @private
     */
    static derivefromElement(elPath) {
        let $ref = null;
        let _respSchema;
        if (!elPath.hasOwnProperty(&quot;operations&quot;)) {
            return elPath;
        }

        const _ops = Object.keys(elPath.operations)
            .filter((op) =&gt; op.match(/^(get|post)+$/));

        // console.log(`get op: ${JSON.stringify(elPath.operations[_ops[0]], null, 2)}`);

        if (_ops.length &gt; 1) {
            $ref = {anyOf: []};
            _ops.forEach((op) =&gt; {
                _respSchema = Utils.getResponseSchema(elPath.operations[op]);
                if (_respSchema !== false) {
                    $ref.anyOf.push(_respSchema);
                }
            });
            $ref.anyOf = uniqWith($ref.anyOf, deepEqual);
        } else {
            $ref = {
                anyOf: [
                    Utils.getResponseSchema(elPath.operations[_ops[0]]),
                ]
            };
        }

        return $ref;
    };

    /**
     * Attempts to derive model schema from GET response
     *
     * @param schema
     * @param scopeSchema
     * @returns {*}
     * @private
     */
    static deriveSchema(schema, scopeSchema) {
        let $ref = Utils.derivefromElement(schema);
        const _rx = new RegExp(&quot;^(allOf|anyOf|anyOf)+$&quot;);
        if (Object.keys($ref).some((k) =&gt; _rx.exec(k) !== null)) {
            return $ref;
        }

        if ($ref !== null) {
            if ((typeof $ref) === &quot;object&quot;) {
                return $ref;
            } else {
                schema = Utils.getComponent($ref, scopeSchema);
                if (schema.hasOwnProperty(&quot;type&quot;) &amp;&amp; schema.type === &quot;array&quot;) {
                    $ref = schema.items.$ref;
                    schema = Utils.getComponent($ref, scopeSchema);
                }
            }
        }

        return schema;
    };
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
